From: Yaroslav Halchenko <debian@onerussian.com>
Subject: Patch debian/ to provide a standalone build of git-annex

Origin: NeuroDebian
Last-Update: 2015-04-20

--- a/debian/control
+++ b/debian/control
@@ -3,105 +3,36 @@ Section: utils
 Priority: optional
 Build-Depends: 
 	debhelper (>= 9),
-	ghc (>= 8.4.3),
-	cabal-install,
-	libghc-mtl-dev (>= 2.1.1),
-	libghc-split-dev,
-	libghc-data-default-dev,
-	libghc-hslogger-dev,
-	libghc-pcre-light-dev,
-	libghc-cryptonite-dev,
-	libghc-memory-dev,
-	libghc-attoparsec-dev,
-	libghc-sandi-dev,
-	libghc-utf8-string-dev,
-	libghc-aws-dev (>= 0.9.2-2~),
-	libghc-conduit-dev,
-	libghc-resourcet-dev,
-	libghc-quickcheck2-dev,
-	libghc-monad-control-dev (>= 0.3),
-	libghc-transformers-dev,
-	libghc-exceptions-dev (>= 0.6),
-	libghc-unix-compat-dev,
-	libghc-dlist-dev,
-	libghc-uuid-dev,
-	libghc-aeson-dev,
-	libghc-tagsoup-dev,
-	libghc-unordered-containers-dev,
-	libghc-ifelse-dev,
-	libghc-bloomfilter-dev,
-	libghc-edit-distance-dev,
-	libghc-hinotify-dev [linux-any],
-	libghc-dbus-dev (>= 0.10.7) [linux-any],
-	libghc-fdo-notify-dev (>= 0.3) [linux-any],
-	libghc-yesod-dev (>= 1.2.6.1)       [i386 amd64 arm64 armel armhf kfreebsd-i386 kfreebsd-amd64 mips mips64el mipsel powerpc ppc64el s390x],
-	libghc-yesod-core-dev (>= 1.2.19)   [i386 amd64 arm64 armel armhf kfreebsd-i386 kfreebsd-amd64 mips mips64el mipsel powerpc ppc64el s390x],
-	libghc-yesod-form-dev (>= 1.3.15)   [i386 amd64 arm64 armel armhf kfreebsd-i386 kfreebsd-amd64 mips mips64el mipsel powerpc ppc64el s390x],
-	libghc-yesod-static-dev (>= 1.2.4)  [i386 amd64 arm64 armel armhf kfreebsd-i386 kfreebsd-amd64 mips mips64el mipsel powerpc ppc64el s390x],
-	libghc-shakespeare-dev (>= 2.0.0)   [i386 amd64 arm64 armel armhf kfreebsd-i386 kfreebsd-amd64 mips mips64el mipsel powerpc ppc64el s390x],
-	libghc-clientsession-dev            [i386 amd64 arm64 armel armhf kfreebsd-i386 kfreebsd-amd64 mips mips64el mipsel powerpc ppc64el s390x],
-	libghc-warp-dev (>= 3.0.0.5)        [i386 amd64 arm64 armel armhf kfreebsd-i386 kfreebsd-amd64 mips mips64el mipsel powerpc ppc64el s390x],
-	libghc-warp-tls-dev                 [i386 amd64 arm64 armel armhf kfreebsd-i386 kfreebsd-amd64 mips mips64el mipsel powerpc ppc64el s390x],
-	libghc-wai-dev                      [i386 amd64 arm64 armel armhf kfreebsd-i386 kfreebsd-amd64 mips mips64el mipsel powerpc ppc64el s390x],
-	libghc-wai-extra-dev                [i386 amd64 arm64 armel armhf kfreebsd-i386 kfreebsd-amd64 mips mips64el mipsel powerpc ppc64el s390x],
-	libghc-dav-dev (>= 1.0),
-	libghc-persistent-dev,
-	libghc-persistent-template-dev,
-	libghc-persistent-sqlite-dev,
-	libghc-microlens-dev,
-	libghc-securemem-dev,
-	libghc-byteable-dev,
-	libghc-stm-chans-dev,
-	libghc-case-insensitive-dev,
-	libghc-http-types-dev,
-	libghc-http-conduit-dev,
-	libghc-blaze-builder-dev,
-	libghc-crypto-api-dev,
-	libghc-network-multicast-dev,
-	libghc-network-info-dev [linux-any kfreebsd-any],
-	libghc-safesemaphore-dev,
-	libghc-async-dev,
-	libghc-monad-logger-dev,
-	libghc-free-dev,
-	libghc-feed-dev (>= 0.3.9.2),
-	libghc-regex-tdfa-dev,
-	libghc-tasty-dev (>= 0.7),
-	libghc-tasty-hunit-dev,
-	libghc-tasty-quickcheck-dev,
-	libghc-tasty-rerun-dev,
-	libghc-optparse-applicative-dev (>= 0.11.0),
-	libghc-torrent-dev,
-	libghc-concurrent-output-dev,
-	libghc-disk-free-space-dev,
-	libghc-mountpoints-dev,
-	libghc-magic-dev,
-	libghc-socks-dev,
-	libghc-vector-dev,
 	lsof [linux-any],
 	ikiwiki,
 	libimage-magick-perl,
 	git (>= 1:1.8.1),
 	rsync,
 	curl,
+	locales,
 	openssh-client,
 	git-remote-gcrypt (>= 0.20130908-6),
 	gnupg,
 	gpg-agent,
+	haskell-stack,
+	libmagic-dev,
+	zlib1g-dev,
+	libtinfo-dev,
 Maintainer: Richard Hartmann <richih@debian.org>
 Standards-Version: 3.9.8
 Vcs-Git: git://git.joeyh.name/git-annex
 Homepage: http://git-annex.branchable.com/
 XS-Testsuite: autopkgtest
 
-Package: git-annex
+Package: git-annex-standalone
 Architecture: any
 Section: utils
-Depends: ${misc:Depends}, ${shlibs:Depends},
-	git (>= 1:1.8.1),
+Conflicts: git-annex
+Provides: git-annex
+Depends: ${misc:Depends},
+	git,
 	netbase,
-	rsync,
-	curl,
-	openssh-client (>= 1:5.6p1)
+	openssh-client
 Recommends: 
 	lsof,
 	gnupg,
@@ -120,7 +51,7 @@ Suggests:
 	libnss-mdns,
 	uftp,
 Breaks: datalad (< 0.11.1~)
-Description: manage files with git, without checking their contents into git
+Description: manage files with git, without checking their contents into git -- standalone build
  git-annex allows managing files with git, without checking the file
  contents into git. While that may seem paradoxical, it is useful when
  dealing with files larger than git can currently easily handle, whether due
@@ -138,3 +69,7 @@ Description: manage files with git, with
  noticing when files are changed, and automatically committing them
  to git and transferring them to other computers. The git-annex webapp
  makes it easy to set up and use git-annex this way.
+ .
+ This package provides a standalone bundle build of git-annex, which
+ should be installable on any more or less recent Debian or Ubuntu
+ release.
--- /dev/null
+++ b/debian/install
@@ -0,0 +1 @@
+tmp/git-annex.linux usr/lib
--- /dev/null
+++ b/debian/links
@@ -0,0 +1,2 @@
+/usr/lib/git-annex.linux/git-annex /usr/bin/git-annex
+/usr/lib/git-annex.linux/git-annex-shell /usr/bin/git-annex-shell
--- a/debian/rules
+++ b/debian/rules
@@ -1,4 +1,5 @@
 #!/usr/bin/make -f
+include /usr/share/dpkg/architecture.mk
 
 export BUILDER=./Setup
 
@@ -11,20 +12,34 @@ STANDALONE_BUILD=$(shell grep -qe '^Pack
 # Do use the changelog's version number, rather than making one up.
 export RELEASE_BUILD=1
 
+export STACK_ROOT=$(PWD)/stack-root
+
 %:
 	dh $@
 
-
 # Standalone build logic/helpers
 ifeq ($(STANDALONE_BUILD),1)
 
+export BUILDER=stack
+
+# verify glibc being old enough
+LIBC=$(shell ldd /usr/bin/file | awk '/libc.so.6/{print $$3;}'`; )
+LIBC_VERSION=$(shell $(LIBC) | awk '/release/{print $$10;}' | sed -e 's/[,]//g')
+
 override_dh_auto_build:
-	make linuxstandalone GIT_ANNEX_PACKAGE_INSTALL=1
+	# TODO: check LIBC_VERSION to be <= 2.25
+	cp stack-lts-9.9.yaml stack.yaml;
+	stack setup;
+	stack build --flag=git-annex:magicmime;
+	make linuxstandalone BUILDER=stack GIT_ANNEX_PACKAGE_INSTALL=1
 
 override_dh_auto_install:
 	make install-desktop install-docs DESTDIR=debian/git-annex-standalone
 	# bins are linked into place, as instructed in debian/install and debian/links
 
+override_dh_auto_test:
+	PATH=$$(stack path --compiler-bin):$$PATH dh_auto_test
+
 override_dh_fixperms:
 	dh_fixperms -Xld-linux
 
@@ -38,4 +53,9 @@ override_dh_strip:
 override_dh_makeshlibs:
 	dh_makeshlibs --noscripts
 
+# For portability to older systems which do not support default (since
+# buster) .xz for components of the .deb
+override_dh_builddeb:
+	dh_builddeb -- -Zgzip
+
 endif
